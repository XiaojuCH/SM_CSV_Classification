# 算法工程师工作流程指南

**面向对象**：负责模型训练的算法工程师  
**目标**：从 Python 模型到交付 DLL 的完整流程

---

## 完整工作流程

**你的工作（算法工程师）：**
1. 修改 train_classifier.py -> 训练模型
2. 运行 export_to_onnx.py -> 导出 ONNX
3. 复制模型文件到 CPP 目录
4. 编译 C++ DLL
5. 测试 DLL
6. 打包交付给 WPF 开发者

**WPF 开发者的工作：**
1. 接收你的文件包
2. 复制到 WPF 项目
3. 调用 DLL 进行预测

---

## 第一步：训练模型

### 1.1 修改训练参数（如果需要）

编辑 `train_classifier.py`：

```python
# 修改类别（如果需要）
data_files = ['DH.csv', 'KD.csv', 'PS10.csv', 'PS10-H.csv', 'QZ.csv', 'YM.csv']
labels = ['DH', 'KD', 'PS10', 'PS10-H', 'QZ', 'YM']

# 修改模型参数（调优）
models = {
    'LightGBM': LGBMClassifier(
        n_estimators=1000,      # 树的数量
        max_depth=15,           # 最大深度
        learning_rate=0.1,      # 学习率
        num_leaves=80,          # 叶子节点数
        random_state=42
    )
}
```

### 1.2 运行训练

```bash
python train_classifier.py
```

**输出文件：**
- `lightgbm_model.pkl` - Python 模型
- `scaler.pkl` - 标准化器
- `confusion_matrix.png` - 混淆矩阵
- `results.txt` - 训练结果

**检查准确率是否满足要求！**

---

## 第二步：导出 ONNX

### 2.1 运行导出脚本

```bash
python export_to_onnx.py
```

**输出文件：**
- `lightgbm_model.onnx` - ONNX 模型（**核心文件**，28 MB）
- `scaler_params.json` - 标准化参数（**必需**）
- `label_mapping.json` - 类别映射（**必需**）

**脚本会自动测试 ONNX 模型，确保正常工作。**

---

## 第三步：编译 C++ DLL

### 3.1 复制模型文件

```bash
copy lightgbm_model.onnx CPPcopy scaler_params.json CPPcopy label_mapping.json CPP```

### 3.2 编译 DLL

```bash
cd CPP

# 首次编译需要配置（只需一次）
cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DONNXRUNTIME_DIR=C:/onnxruntime

# 编译
cmake --build build --config Release
```

**编译输出位置：** `CPP/build/bin/Release/`

**输出文件：**
- `ClassifierDLL.dll` - 主 DLL
- `onnxruntime.dll` - 依赖库
- `SimpleClassifier.exe` - 测试工具
- `lightgbm_model.onnx` - 模型文件
- `scaler_params.json` - 标准化参数
- `label_mapping.json` - 类别映射

### 3.3 测试 DLL

```bash
cd buildin\Release
.\SimpleClassifier.exe ..\..\..\TEST.csv
```

**确保预测结果正确！**

---

## 第四步：交付文件

### 4.1 需要交付的文件

```
交付文件包/
├── ClassifierDLL.dll          # 主 DLL（必需）
├── onnxruntime.dll            # 依赖库（必需）
├── lightgbm_model.onnx        # 模型文件（必需，28 MB）
├── scaler_params.json         # 标准化参数（必需）
├── label_mapping.json         # 类别映射（必需）
├── Classifier.cs              # C# 包装类（推荐）
└── API说明.txt                # API 文档（推荐）
```

### 4.2 打包命令

```bash
# 创建目录
mkdir 交付文件包

# 复制文件
copy CPPuildin\Release\ClassifierDLL.dll 交付文件包copy CPPuildin\Release\onnxruntime.dll 交付文件包copy CPPuildin\Release\lightgbm_model.onnx 交付文件包copy CPPuildin\Release\scaler_params.json 交付文件包copy CPPuildin\Release\label_mapping.json 交付文件包copy CPP\ClassifierWrapper.cs 交付文件包\Classifier.cs
```

### 4.3 创建 API 说明文档

在 `交付文件包/` 中创建 `API说明.txt`：

```
分类器 DLL API 说明
==================

【模型信息】
- 类别数量：6 个（DH、KD、PS10、PS10-H、QZ、YM）
- 特征数量：20 个
- 准确率：81.65%
- 预测速度：< 1 毫秒

【输入要求】
- 特征数量：20 个 float 值
- CSV 格式：每行 20 个特征，逗号分隔，无表头

【输出格式】
- 预测类别索引：0-5
- 预测类别名称：DH、KD、PS10、PS10-H、QZ、YM
- 置信度：0-1
- 概率分布：长度为 6 的数组

【使用方法】
1. 将所有文件放在同一目录
2. 调用 Initialize 初始化
3. 调用 Predict 进行预测
4. 使用完毕调用 Cleanup

【C# 调用示例】
using (var classifier = new Classifier())
{
    classifier.InitializeClassifier(
        "lightgbm_model.onnx",
        "scaler_params.json",
        "label_mapping.json"
    );

    float[] features = new float[20] { /* 你的数据 */ };
    var result = classifier.Predict(features);

    Console.WriteLine($"预测: {result.ClassName}");
    Console.WriteLine($"置信度: {result.Confidence:P2}");
}

【注意事项】
- 所有文件必须在同一目录
- 必须先初始化才能预测
- 平台必须是 x64
```

---

## 常见修改场景

### 场景 1：调整模型参数（最常见）

**步骤：**
```bash
# 1. 修改 train_classifier.py 中的参数
# 2. 重新训练
python train_classifier.py

# 3. 重新导出
python export_to_onnx.py

# 4. 复制模型文件
copy lightgbm_model.onnx CPPcopy scaler_params.json CPPcopy label_mapping.json CPP
# 5. 重新编译
cd CPP
cmake --build build --config Release

# 6. 测试
cd buildin\Release
.\SimpleClassifier.exe ..\..\..\TEST.csv

# 7. 重新打包交付
```

### 场景 2：增加或减少类别

**步骤：**
```python
# 1. 修改 train_classifier.py
data_files = ['DH.csv', 'KD.csv', 'NEW_CLASS.csv']  # 添加新类别
labels = ['DH', 'KD', 'NEW_CLASS']

# 2-7. 同场景 1
```

**注意：** C++ 代码会自动适配，不需要修改！

### 场景 3：修改特征数量

**步骤：**
```python
# 1. 修改 export_to_onnx.py
initial_type = [('float_input', FloatTensorType([None, 25]))]  # 改为新数量

# 2. 修改 ClassifierDLL.cpp
if (row.size() == 25) {  # 改为新数量
    data.push_back(row);
}

# 3-7. 同场景 1
```

**注意：** 需要通知 WPF 开发者特征数量变化！

---

## 与 WPF 开发者对接

### 交付清单

| 文件 | 说明 | 必需性 |
|------|------|--------|
| ClassifierDLL.dll | 主 DLL | [必需] |
| onnxruntime.dll | 依赖库 | [必需] |
| lightgbm_model.onnx | 模型文件 | [必需] |
| scaler_params.json | 标准化参数 | [必需] |
| label_mapping.json | 类别映射 | [必需] |
| Classifier.cs | C# 包装类 | [推荐] |
| API说明.txt | API 文档 | [推荐] |

### WPF 开发者需要知道的信息

**输入格式：**
- 特征数量：20 个
- 数据类型：float
- CSV 格式：每行 20 个特征，逗号分隔，无表头

**输出格式：**
- 预测类别：字符串（如 "YM"）
- 置信度：0-1 的浮点数
- 概率分布：长度为 6 的数组

**使用方法：**
1. 将所有文件放在程序目录
2. 先调用 Initialize
3. 再调用 Predict
4. 使用完毕调用 Cleanup

### 沟通模板

```
主题：分类器 DLL v1.0 交付

你好，

我已完成模型训练和 DLL 封装，现交付给你。

【文件位置】
[共享文件夹路径或网盘链接]

【模型信息】
- 类别：6 个（DH、KD、PS10、PS10-H、QZ、YM）
- 特征：20 个
- 准确率：81.65%

【使用方法】
1. 将所有文件复制到 WPF 项目输出目录
2. 使用 Classifier.cs 调用 DLL
3. 详见 API说明.txt

【注意事项】
- 平台必须是 x64
- 所有文件必须在同一目录

如有问题请联系我。
```

---

## 快速参考

### 完整命令流程

```bash
# 训练和导出
python train_classifier.py
python export_to_onnx.py

# 复制模型文件
copy lightgbm_model.onnx CPPcopy scaler_params.json CPPcopy label_mapping.json CPP
# 编译 DLL
cd CPP
cmake --build build --config Release

# 测试
cd buildin\Release
.\SimpleClassifier.exe ..\..\..\TEST.csv

# 打包交付
cd ..\..\..\..
mkdir 交付文件包
copy CPPuildin\Release\*.dll 交付文件包copy CPPuildin\Release\*.onnx 交付文件包copy CPPuildin\Release\*.json 交付文件包copy CPP\ClassifierWrapper.cs 交付文件包\Classifier.cs
```

### 常见问题

**Q: 编译失败，找不到 ONNX Runtime？**  
A: 检查 `DONNXRUNTIME_DIR` 路径是否正确（应该是 `C:/onnxruntime`）

**Q: WPF 开发者说找不到 DLL？**  
A: 确保 DLL 在程序输出目录，且平台是 x64

**Q: 预测结果不对？**  
A: 检查输入数据是否正确（20 个特征，顺序正确）

**Q: 想修改类别名称？**  
A: 修改 `label_mapping.json`，重新编译 DLL

---

## 总结

### 你的核心工作

1. [完成] 训练模型（Python）
2. [完成] 导出 ONNX（Python）
3. [完成] 编译 DLL（C++）
4. [完成] 测试验证
5. [完成] 打包交付

### WPF 开发者不需要知道

- [X] Python 代码
- [X] 训练过程
- [X] 模型内部结构
- [X] C++ 实现细节

### WPF 开发者需要知道

- [O] 输入格式（20 个特征）
- [O] 输出格式（类别、概率）
- [O] 使用方法（Initialize -> Predict -> Cleanup）
- [O] 文件依赖（5 个必需文件）

---

**详细文档请参考：**
- README.md - 主项目文档
- CPP/DLL使用指南.md - DLL 详细说明
- WPF_Classifier_Demo/README.md - WPF 项目说明
