# 图表可视化使用指南

## 📊 概述

WPF 分类器 Demo 现在支持**实时图表可视化**，可以直观地显示预测结果的概率分布。

**重要**：图表功能**完全基于 DLL 的输出数据**，不需要修改 C++ DLL 代码。

---

## ✨ 新增功能

### 1. 柱状图（Bar Chart）
- 显示所有 6 个类别的概率百分比
- 每个类别用不同颜色标识
- 预测的类别会在标题中突出显示

### 2. 饼图（Pie Chart）
- 显示概率分布的占比
- 预测的类别会"爆炸"突出显示
- 自动隐藏小于 0.01% 的类别

---

## 🎨 界面布局

```
┌─────────────────────────────────────────────────────────┐
│              光学特征分类系统                            │
├─────────────────────────────────────────────────────────┤
│  状态: ✓ 分类器已初始化                                 │
├─────────────────────────────────────────────────────────┤
│     [单样本预测]      [批量 CSV 预测]                   │
├──────────────────┬──────────────────────────────────────┤
│  文字结果        │  图表可视化                          │
│                  │  ┌────────────────────────────────┐  │
│  预测类别: YM    │  │  概率分布 - 柱状图             │  │
│  置信度: 99.99%  │  │  [彩色柱状图显示]              │  │
│                  │  └────────────────────────────────┘  │
│  所有类别概率:   │  ┌────────────────────────────────┐  │
│    DH: 0.00%     │  │  概率分布 - 饼图               │  │
│    KD: 0.00%     │  │  [彩色饼图显示]                │  │
│    ...           │  └────────────────────────────────┘  │
└──────────────────┴──────────────────────────────────────┘
```

---

## 🚀 使用步骤

### 步骤 1: 安装依赖

项目已经配置好了 OxyPlot 依赖，首次编译时会自动下载。

如果需要手动安装：
```bash
cd WPF_Classifier_Demo
dotnet add package OxyPlot.Wpf --version 2.1.2
```

### 步骤 2: 编译项目

```bash
cd WPF_Classifier_Demo
dotnet build -c Debug
```

### 步骤 3: 复制 DLL 和模型文件

```bash
copy ..\CPP\build\bin\Release\*.dll bin\x64\Debug\net6.0-windows\
copy ..\CPP\build\bin\Release\*.onnx bin\x64\Debug\net6.0-windows\
copy ..\CPP\build\bin\Release\*.json bin\x64\Debug\net6.0-windows\
```

### 步骤 4: 运行程序

```bash
dotnet run
```

或者在 Visual Studio 中按 F5。

### 步骤 5: 进行预测

1. **单样本预测**：点击"单样本预测"按钮
   - 左侧显示文字结果
   - 右侧自动显示柱状图和饼图

2. **批量 CSV 预测**：点击"批量 CSV 预测"按钮
   - 选择 CSV 文件
   - 左侧显示所有样本的文字结果
   - 右侧显示最后一个样本的图表

---

## 🎨 图表说明

### 柱状图特点

- **X 轴**：概率百分比 (0-100%)
- **Y 轴**：6 个类别名称
- **颜色**：每个类别有独特的颜色
  - 🔴 DH (红色)
  - 🔵 KD (蓝色)
  - 🟡 PS10 (黄色)
  - 🟢 PS10-H (青色)
  - 🟣 QZ (紫色)
  - 🟠 YM (橙色)
- **标题**：显示预测结果和置信度

### 饼图特点

- **扇区大小**：代表概率占比
- **颜色**：与柱状图一致
- **突出显示**：预测的类别会"爆炸"突出
- **自动过滤**：小于 0.01% 的类别不显示

---

## 💡 数据流程

```
DLL 预测
    ↓
返回 PredictionResult {
    ClassIndex: 5
    ClassName: "YM"
    Confidence: 0.9999
    Probabilities: [0.0, 0.0, 0.0, 0.0, 0.0, 0.9999]  ← 关键数据
}
    ↓
WPF 读取 Probabilities 数组
    ↓
绘制柱状图和饼图
```

**重点**：图表完全基于 `result.Probabilities` 数组，不需要修改 DLL！

---

## 🔧 自定义图表

### 修改颜色

编辑 `MainWindow.xaml.cs` 中的 `classColors` 数组：

```csharp
private readonly OxyColor[] classColors =
{
    OxyColor.FromRgb(255, 99, 132),   // DH - 改为你喜欢的颜色
    OxyColor.FromRgb(54, 162, 235),   // KD
    // ...
};
```

### 修改图表大小

编辑 `MainWindow.xaml` 中的 `Height` 属性：

```xml
<oxy:PlotView x:Name="BarChartView" Height="220"/>  <!-- 改为你想要的高度 -->
<oxy:PlotView x:Name="PieChartView" Height="220"/>
```

### 修改窗口大小

编辑 `MainWindow.xaml` 中的窗口属性：

```xml
<Window ... Height="700" Width="1200" ...>  <!-- 改为你想要的尺寸 -->
```

### 添加更多图表类型

你可以添加其他类型的图表，例如：

1. **折线图**：显示多次预测的趋势
2. **雷达图**：多维度展示
3. **热力图**：显示混淆矩阵

只需要在 `UpdateCharts` 方法中添加新的图表绘制函数即可。

---

## 📝 代码说明

### 核心方法

#### UpdateCharts(PredictionResult result)
主方法，调用柱状图和饼图的绘制函数。

```csharp
private void UpdateCharts(Classifier.PredictionResult result)
{
    UpdateBarChart(result);   // 绘制柱状图
    UpdatePieChart(result);   // 绘制饼图
}
```

#### UpdateBarChart(PredictionResult result)
绘制柱状图，显示所有类别的概率。

**关键代码**：
```csharp
// 直接使用 DLL 返回的 Probabilities 数组
for (int i = 0; i < result.Probabilities.Length; i++)
{
    barSeries.Items.Add(new BarItem
    {
        Value = result.Probabilities[i] * 100,  // 转换为百分比
        Color = classColors[i]
    });
}
```

#### UpdatePieChart(PredictionResult result)
绘制饼图，显示概率分布。

**关键代码**：
```csharp
// 直接使用 DLL 返回的 Probabilities 数组
for (int i = 0; i < result.Probabilities.Length; i++)
{
    double percentage = result.Probabilities[i] * 100;

    if (percentage > 0.01)  // 只显示大于 0.01% 的类别
    {
        pieSeries.Slices.Add(new PieSlice(
            classNames[i],
            result.Probabilities[i]
        )
        {
            Fill = classColors[i],
            IsExploded = i == result.ClassIndex  // 突出显示预测的类别
        });
    }
}
```

---

## ⚠️ 常见问题

### Q1: 图表不显示

**原因**：OxyPlot 包未正确安装。

**解决方案**：
```bash
cd WPF_Classifier_Demo
dotnet restore
dotnet build
```

### Q2: 编译错误：找不到 OxyPlot

**原因**：项目文件中缺少 OxyPlot 引用。

**解决方案**：
检查 `ClassifierDemo.csproj` 文件中是否包含：
```xml
<ItemGroup>
  <PackageReference Include="OxyPlot.Wpf" Version="2.1.2" />
</ItemGroup>
```

### Q3: 图表显示空白

**原因**：数据未正确传递。

**解决方案**：
确保在预测后调用了 `UpdateCharts(result)`。

### Q4: 饼图只显示一个扇区

**原因**：这是正常的！如果某个类别的概率接近 100%，其他类别的概率会非常小（< 0.01%），会被自动隐藏。

**说明**：这说明模型对预测结果非常有把握。

### Q5: 想要显示所有类别（即使概率很小）

**解决方案**：
修改 `UpdatePieChart` 方法中的过滤条件：

```csharp
// 将这一行
if (percentage > 0.01)

// 改为
if (percentage > 0.0001)  // 或者完全去掉这个判断
```

---

## 🎯 最佳实践

### 1. 保持 DLL 简洁
- DLL 只负责预测，返回数据
- 所有可视化逻辑在 WPF 中实现

### 2. 利用 WPF 优势
- 使用成熟的 C# 图表库
- 充分利用 WPF 的 UI 能力
- 易于添加动画和交互

### 3. 数据驱动
- 图表完全基于 DLL 返回的数据
- 修改图表不需要重新编译 DLL
- 易于维护和扩展

---

## 📚 扩展阅读

### OxyPlot 官方文档
- 官网：https://oxyplot.github.io/
- GitHub：https://github.com/oxyplot/oxyplot
- 示例：https://oxyplot.github.io/examples/

### 其他图表库

如果你想尝试其他图表库：

1. **LiveCharts**
   - 更现代的设计
   - 更好的动画效果
   - 安装：`dotnet add package LiveChartsCore.SkiaSharpView.WPF`

2. **ScottPlot**
   - 专注于科学数据可视化
   - 性能优秀
   - 安装：`dotnet add package ScottPlot.WPF`

3. **Syncfusion Charts**
   - 功能最强大
   - 商业许可（有免费版）
   - 安装：`dotnet add package Syncfusion.SfChart.WPF`

---

## 🎉 总结

✅ **图表功能已完成**
- 柱状图显示概率分布
- 饼图显示概率占比
- 完全基于 DLL 输出数据
- 不需要修改 DLL 代码

✅ **优势**
- DLL 保持轻量
- WPF 充分发挥优势
- 易于定制和扩展
- 符合软件工程最佳实践

✅ **下一步**
- 添加更多图表类型（折线图、雷达图等）
- 添加动画效果
- 添加交互功能（点击查看详情）
- 添加导出功能（保存图表为图片）

---

**如有问题，请参考主项目 README 或 WPF 项目 README。**
